<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ChatGPTé£æ ¼æé—®é¡µé¢</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      font-family: "Segoe UI", "PingFang SC", Arial, sans-serif;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      height: 90vh;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px #ddd;
      display: flex;
      padding: 0;
      overflow: hidden;
    }

    /* å·¦ä¾§èœå•æ ·å¼ */
    .sidebar {
      width: 200px;
      background: #2c3e50;
      color: #fff;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
    }

    .menu-item {
      padding: 12px 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.3s;
    }

    .menu-item:hover,
    .menu-item.active {
      background: #34495e;
    }

    .menu-item i {
      font-size: 18px;
    }

    /* ä¸»å†…å®¹åŒºåŸŸæ ·å¼ */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow: hidden;
    }

    /* èŠå¤©åŒºåŸŸæ ·å¼ */
    .chat-section {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .chat-box {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      border: 1px solid #eee;
      border-radius: 6px;
    }

    .message {
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 16px;
      word-break: break-word;
    }

    .user {
      align-self: flex-end;
      background: #e0f7fa;
    }

    .assistant {
      align-self: flex-start;
      background: #f1f8e9;
    }

    .input-area {
      display: flex;
      gap: 8px;
    }

    .input-area input {
      flex: 1;
      padding: 8px 12px;
      font-size: 16px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .input-area button {
      padding: 8px 20px;
      font-size: 16px;
      border-radius: 4px;
      border: none;
      background: #1976d2;
      color: #fff;
      cursor: pointer;
    }

    .input-area button:disabled {
      background: #90caf9;
      cursor: not-allowed;
    }

    /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸæ ·å¼ */
    .upload-section {
      display: none;
      height: 100%;
      flex-direction: column;
    }

    .upload-area {
      flex: 1;
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 10px;  /* å‡å°å†…è¾¹è· */
      text-align: center;
      margin-bottom: 10px;  /* å‡å°åº•éƒ¨é—´è· */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 8px;  /* æ·»åŠ ç»Ÿä¸€çš„é—´è· */
    }

    .upload-area i {
      font-size: 36px;  /* å‡å°å›¾æ ‡å¤§å° */
      margin-bottom: 0px;  /* å‡å°å›¾æ ‡åº•éƒ¨é—´è· */
    }

    .upload-area h3 {
      margin: 0 0 0px 0;  /* å‡å°æ ‡é¢˜åº•éƒ¨é—´è· */
    }

    .upload-area p {
      margin: 0 0 8px 0;  /* å‡å°æ®µè½åº•éƒ¨é—´è· */
    }

    .upload-area:hover {
      border-color: #666;
    }

    .file-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 4px;
    }

    .file-list li {
      padding: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .file-list li:last-child {
      border-bottom: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- å·¦ä¾§èœå• -->
    <div class="sidebar">
      <div class="menu-item active" onclick="switchSection('chat')">
        <i>ğŸ’¬</i>
        <span>å¯¹è¯</span>
      </div>
      <div class="menu-item" onclick="switchSection('upload')">
        <i>ğŸ“</i>
        <span>æ–‡ä»¶ä¸Šä¼ </span>
      </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
      <!-- èŠå¤©åŒºåŸŸ -->
      <div class="chat-section" id="chatSection">
        <div class="chat-box" id="chatBox"></div>
        <div class="input-area">
          <input id="input" type="text" placeholder="è¯·è¾“å…¥ä½ çš„é—®é¢˜..." />
          <button id="sendBtn">å‘é€</button>
        </div>
      </div>

      <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
      <div class="upload-section" id="uploadSection">
        <h2 style="text-align: left; margin: 0 0 16px 0; color: #333;">çŸ¥è¯†åº“æ–‡ä»¶ä¸Šä¼ </h2>
        <div class="upload-area" id="dropZone">
          <i style="font-size: 48px; margin-bottom: 0px;">ğŸ“¤</i>
          <h3>æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ</h3>
          <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ <br>æ”¯æŒpdfã€docã€txtã€htmlç±»å‹æ–‡ä»¶</p>
          <input type="file" id="fileInput" multiple style="display: none">
          <button onclick="document.getElementById('fileInput').click()"
            style="background: #1976d2; color: #fff; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer;">
            é€‰æ‹©æ–‡ä»¶
          </button>
        </div>
        <ul class="file-list" id="fileList"></ul>
      </div>
    </div>
  </div>

  <script>
    // åˆ‡æ¢åŠŸèƒ½åŒºåŸŸ
    function switchSection(section) {
      const chatSection = document.getElementById('chatSection');
      const uploadSection = document.getElementById('uploadSection');
      const menuItems = document.querySelectorAll('.menu-item');

      menuItems.forEach(item => item.classList.remove('active'));

      if (section === 'chat') {
        chatSection.style.display = 'flex';
        uploadSection.style.display = 'none';
        menuItems[0].classList.add('active');
      } else {
        chatSection.style.display = 'none';
        uploadSection.style.display = 'flex';
        menuItems[1].classList.add('active');
      }
    }

    // èŠå¤©åŠŸèƒ½
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const chatBox = document.getElementById('chatBox');

    function appendMessage(role, content = '') {
      const div = document.createElement('div');
      div.className = 'message ' + (role === 'user' ? 'user' : 'assistant');
      div.textContent = content;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      return div;
    }

    async function sendMessage() {
      const question = input.value.trim();
      if (!question) return;

      appendMessage('user', question);
      input.value = '';
      input.disabled = true;
      sendBtn.disabled = true;

      const assistantMsg = appendMessage('assistant', 'æ­£åœ¨æ€è€ƒ');

      try {
        const res = await fetch('http://localhost:8059/ocrpdf?a=' + encodeURIComponent(question), {
          method: 'GET',
          headers: {
            Accept: 'text/event-stream',
          }
        });

        if (!res.body) throw new Error('å“åº”ä½“ä¸ºç©º');

        const reader = res.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          buffer += chunk;

          const lines = buffer.split('\n\n');
          const lastMsg = chatBox.querySelector('.assistant:last-child');
          if (lastMsg) assistantMsg.textContent += chunk;
          chatBox.scrollTop = chatBox.scrollHeight;
          await new Promise(resolve => setTimeout(resolve, 20));
        }
      } catch (e) {
        assistantMsg.textContent = 'è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚';
      }

      input.disabled = false;
      sendBtn.disabled = false;
      input.focus();
    }

    sendBtn.onclick = sendMessage;
    input.onkeydown = function (e) {
      if (e.key === 'Enter') sendMessage();
    };

    // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');

    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    async function uploadFile(file) {
      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch('http://localhost:8059/fileUpload', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('ä¸Šä¼ å¤±è´¥');
        }

        const result = await response.json();
        // æ·»åŠ æ–‡ä»¶åˆ°åˆ—è¡¨
        const li = document.createElement('li');
        li.textContent = `${file.name} - ä¸Šä¼ æˆåŠŸ`;
        fileList.appendChild(li);
      } catch (error) {
        console.error('ä¸Šä¼ å‡ºé”™ï¼š', error);
        const li = document.createElement('li');
        li.textContent = `${file.name} - ä¸Šä¼ å¤±è´¥`;
        li.style.color = 'red';
        fileList.appendChild(li);
      }
    }

    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    fileInput.addEventListener('change', (e) => {
      const files = e.target.files;
      if (files) {
        Array.from(files).forEach(uploadFile);
      }
    });

    // å¤„ç†æ‹–æ‹½
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#1976d2';
    });

    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#ccc';
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#ccc';
      const files = e.dataTransfer.files;
      if (files) {
        Array.from(files).forEach(uploadFile);
      }
    });

    function handleFiles(files) {
      Array.from(files).forEach(file => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${file.name} (${formatFileSize(file.size)})</span>
          <button onclick="this.parentElement.remove()" style="background: none; border: none; color: #f44336; cursor: pointer;">åˆ é™¤</button>
        `;
        fileList.appendChild(li);
      });
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
  </script>
</body>
</html>